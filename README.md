# RAG Telegram Bot с графовой базой знаний
Проект представляет собой Telegram-бота, который отвечает на вопросы о вселенной Warhammer 40k с использованием Retrieval-Augmented Generation (RAG). 
Бот комбинирует поиск по векторному хранилищу документов и графовый анализ для генерации информативных ответов. 
Графовая база Neo4j используется для фильтрации нерелевантных фрагментов, поиска дополнительных релевантных чанков и обогащения контекста за счёт связей между фрагментами.

**Основные возможности:**
- Разделение сложных вопросов на под-вопросы и извлечение ключевых сущностей.
- Поиск релевантных документов в **Chroma-векторном хранилище** по под-вопросам и сущностям.
- Фильтрация нерелевантных чанков и поиск дополнительных релевантных фрагментов с обогащением контекста за счёт связей сущностей в **графовой базе Neo4j**.
- Генерация текстового ответа с использованием **LLM** с учётом найденного контекста.
- Отправка форматированных ответов пользователю через **Telegram**, включая источники информации.
- **Дообучение модели** эмбеддингов на кастомном датасете для более точного поиска релевантных документов.
- Создание и подготовка **собственного датасета** для генерации эмбеддингов, адаптированного под специфику данных.


### **Общий пайплайн**

* Пользователь отправляет вопрос в Telegram.
* Вопрос разбивается на под-вопросы, извлекаются ключевые сущности.
* Ретривер ищет релевантные документы в Chroma-векторном хранилище.
* **Графовая база**:
  * фильтрует нерелевантные фрагменты,
  * ищет дополнительные релевантные узлы,
  * добавляет контекст о взаимосвязях между чанками.
* LLM генерирует финальный ответ с учётом найденного контекста.
* Ответ форматируется и отправляется пользователю через Telegram.

<img width="1247" height="654" alt="RAG drawio(1)" src="https://github.com/user-attachments/assets/41b7fafb-d4db-46c8-930e-79192051eaab" />

### **Технологический стек**

* **Язык и фреймворки:** Python, aiogram.
* **RAG:** LangChain.
* **Векторное хранилище:** Chroma.
* **Генерация эмбеддингов:** sentence-transformers.
* **LLM:** GigaChat.
* **Графовая база:** Neo4j.
* **Docker:** контейнеризация.


### **Источник и подготовка данных:**
* Данные собирались с **Warhammer 40k Fandom** с помощью парсера на Python.
* Статьи сохраняются в **SQLite базу**.
* Из текстов извлекаются источники и ключевые ссылки между сущностями для последующего использования в графовой базе.
* Тексты статей делятся на семантически осмысленные фрагменты (чанки).

## **Дообучение (fine-tuning) модели эмбеддингов**
* Для каждого чанка с помощью LLM (**GigaChat**) генерировались 4 вопроса, покрывающих факты и объяснения из фрагмента, в формате JSON.
* Результаты сохранялись в базе данных SQLite.
* Использовалась предобученная модель **sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2**.
* Дообучение проводилось на сгенерированных парах «чанк — вопрос».
* После дообучения эмбеддинги интегрировались в **Chroma**, что повышало точность поиска и качество генерации в RAG-пайплайне.

## **Формирование графовой базы знаний**

Графовая база знаний в Neo4j строится на основе данных из статей. Каждый элемент графа несёт позволяет  моделировать взаимосвязи между сущностями.
#### **Элементы графа**
1. **Узлы (Nodes)**  
   Узлы представляют ключевые сущности и объекты вселенной, например: персонажи, организации и сражения.
   Каждый узел содержит метаданные: название, описание и категории. 
2. **Связи (Relationships)**  
   Связи отражают отношения между сущностями:  
   - Прямые действия и принадлежность (`КОМАНДОВАНИЕ`, `УЧАСТВУЕТ`, `ПРЕДСТАВЛЯЕТ`).  
   - Исторические и логические связи (`ПРЕДЫДУЩАЯ`, `СЛЕДУЮЩАЯ`).  
   - Ссылки на источники и статьи (`ССЫЛКА`).  

#### **Процесс построения графа**
1. Для каждой статьи (сущности) создаётся узел с метаданными и типами.  
2. Формируются связи между узлами на основе инфобоксов и ссылок между статьями. 
В результате формируется структурированная графовая база, в которой узлы отражают ключевые сущности, а связи моделируют их взаимодействия и принадлежности.  

## **Использование графовой базы знаний для обогащения контекста**

После извлечения релевантных документов с помощью векторного поиска, графовая база Neo4j используется для дополнительной фильтрации и расширения контекста:
1. **Фильтрация нерелевантных фрагментов**  
   Для найденных документов оценивается их связность в графе. Узлы с нулевым графовым весом и одиночные фрагменты могут быть исключены, что снижает шум и повышает точность ответа.
2. **Поиск дополнительных релевантных узлов**  
   На основе найденных узлов вычисляются кратчайшие пути между ними, и промежуточные узлы добавляются в контекст. Это позволяет учитывать связанные сущности, которые не были найдены напрямую в векторном поиске.
3. **Обогащение контекста связями**  
   Для каждого узла можно извлечь входящие и исходящие связи с другими сущностями, а также метаданные. Эта информация включается в итоговый текстовый контекст для LLM.
4. **Формирование графовых путей**  
   Дополнительно создаются отдельные текстовые блоки с описанием найденных путей между узлами, включая типы отношений. Это помогает LLM учитывать взаимосвязи между сущностями при генерации ответа.

**Преимущества использования графа:**
- Улучшает качество поиска, объединяя векторный и структурный подходы.
- Позволяет находить скрытые связи между объектами вселенной Warhammer 40k.
- Снижает вероятность пропуска релевантной информации при генерации ответа.



